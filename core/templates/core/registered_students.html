<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registered Students</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Registered Students</h1>
    <p>Welcome, {{ user.username }}!</p>

    <!-- Filter Form -->
    <form method="get">
        {{ filter_form.as_p }}
        <button type="submit">Filter</button>
    </form>

    <!-- Action Buttons -->
    <button id="edit-selected" disabled>Edit Selected</button>
    <button id="delete-selected" disabled>Delete Selected</button>

    <!-- Students Table -->
    <form id="students-form" method="post">
        {% csrf_token %}
        <table border="1">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Class</th>
                    <th>Department</th>
                    <th>School</th>
                    <th>College</th>
                    <th>Campus</th>
                    <th>NFC URL</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                    <tr>
                        <td><input type="checkbox" class="select-student" name="selected_students" value="{{ student.id }}"></td>
                        <td>{{ student.student_id }}</td>
                        <td>{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ student.gender }}</td>
                        <td>{{ student.student_class }}</td>
                        <td>{{ student.department }}</td>
                        <td>{{ student.school }}</td>
                        <td>{{ student.college }}</td>
                        <td>{{ student.campus }}</td>
                        <td>
                            {% if student.nfc_url %}
                                <a href="{{ student.nfc_url }}" target="_blank">View NFC Link</a>
                            {% else %}
                                Not Assigned
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="10">No students found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <a href="{% url 'registrar-dashboard' %}">Back to Dashboard</a>

    <!-- JavaScript for Select All and Action Buttons -->
    <script>
        $(document).ready(function () {
            // Enable/Disable action buttons based on selection
            function toggleActionButtons() {
                const anySelected = $('.select-student:checked').length > 0;
                $('#edit-selected').prop('disabled', !anySelected);
                $('#delete-selected').prop('disabled', !anySelected);
            }

            // Select All functionality
            $('#select-all').change(function () {
                $('.select-student').prop('checked', $(this).prop('checked'));
                toggleActionButtons();
            });

            // Toggle action buttons when individual checkboxes are selected/deselected
            $('.select-student').change(function () {
                toggleActionButtons();
            });

            // Edit Selected Students
            $('#edit-selected').click(function (e) {
                e.preventDefault();
                const selectedStudents = $('.select-student:checked').map(function () {
                    return $(this).val();
                }).get();

                if (selectedStudents.length === 1) {
                    // Redirect to the edit page for a single student
                    window.location.href = `/registrar/edit-student/${selectedStudents[0]}/`;
                } else {
                    // Redirect to the bulk edit page
                    window.location.href = `/registrar/edit-students/?ids=${selectedStudents.join(',')}`;
                }
            });

            // Delete Selected Students
            $('#delete-selected').click(function (e) {
                e.preventDefault();
                if (confirm('Are you sure you want to delete the selected students?')) {
                    $('#students-form').attr('action', '{% url "delete-students" %}');
                    $('#students-form').submit();
                }
            });
        });
    </script>
</body>
</html>